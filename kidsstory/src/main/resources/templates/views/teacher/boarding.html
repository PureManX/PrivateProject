<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
	  layout:decorator="layout/mobileLayout">
<head>
	<link rel="stylesheet" th:href="@{/adminlte/dist/css/AdminLTE.min.css}"/>
	<link rel="stylesheet" th:href="@{/adminlte/dist/css/skins/skin-red-light.min.css}"/>
	<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet" />
	<style>

		div.bus-line-container {
			background: #ececec;
			padding-bottom: 10px;
			padding-top: 10px;
		}

		.timeline {
			margin: 0;
		}
		.timeline:before {
			left : 38px;
			background: #FFFFFF;
		}
		.timeline>li {
			margin-left: 10px;
		}
		.timeline>li:last-child {
			margin-bottom: 0;
		}
		.timeline>li>.fa {
			width: 30px;
			height: 30px;
			left: 15px;
			border: 2px solid #FFFFFF;
			z-index: 50;
			background: #d6d6d6;
			top: 15px;
   		}
		.timeline>li>.fa.board {
			border : 2px solid #828282;
		}
		.timeline>li>.timeline-item {
			margin-left: 70px;
			margin-right: 0px;
			-webkit-box-shadow: none;
			box-shadow: none;
		}

		.timeline-header>.headerName {
			color: #6d6b4f;
			font-size : 20px;
		}
		.timeline-header>.headerClassName {
			color: #6d6b4f;
			font-size : 16px;
		}

		.bus-line-header {
			z-index: 1999;
		}
		.bus-line-header>.box {
			background: #ffdf00;
			margin-bottom: 0;
			/*-webkit-transition: all 1s ease-in-out;*/
			/*transition: all 1s ease-in-out;*/
			box-shadow: none;
		}
		.bus-line-header>.box>.widget-user-header {
			padding : 3vw;
			color : #484844;
		}
		.bus-line-header .widget-user-image img.teacher-image {
			width : 50px;
			height: 50px;
		}
		.bus-line-header .bus-line-area {
			margin-top: 5px;
		}
		.bus-line-header .bus-line-name {
			font-size: 18px;
			margin-left: 15px;
		}

		.bus-line-header .teacher-name {
			font-size: 15px;
			margin-left: 10px;
		}
		.bus-line-header .bus-image {
			width: 25px;
			height: auto;
		}
		.bus-line-header .bus-icon {
			float: right;
		}
		.affix .teacher-name {
			display: none;
		}
		.affix .bus-icon {
			margin-top: 6px;
		}
		.affix .box {
			height: 15vw;
		}
		.affix {
			width: 100%;
			height: 15vw;
			left: 0;
			top: 0;
			overflow: hidden;
			position: fixed;
			-webkit-transition: all 1s ease-in-out;
			transition: all 1s ease-in-out;
			z-index: 1999;
			-webkit-align-items: center;
			align-items: center;
			-webkit-justify-content: center;
			justify-content: center;
		}
		.bus-line-header.affix .widget-user-image img.teacher-image{
			width: 9vw;
			height: 9vw;
			float: left;
		}


		.timeline-item>.no-current {
			height: 60px;
		}
		div.timeline-item.board {
			border: 1px solid #00a65a;
			box-sizing: border-box;
			background: #e2fff2;
		}
		div.timeline-item.unboard {
			border: 1px solid #dd4b39;
			box-sizing: border-box;
			background: #f8f2f2;
		}
		.timeline-header .button-area {
			float: right;
		}

		.timeline>li>.timeline-item>.time {
			color: #4d4d4d;
		}

		.board .address, .unboard .address {
			margin-top: 4px;
		}
		.address>span {
			margin-top: 2px;
			font-size: 13px;
		}

		.btn.btn-xs {
			width: 18vw;
		}

		.unboard:before, .board:before {
			content: '';
			position: absolute;
			top: 0;
			width: 4px;
			background: #777777;
			left: -43px;
			margin: 0;
			bottom: -30px;
		}
		.bus-line-header:before {
			content: '';
			position: absolute;
			top: 5px;
			width: 4px;
			background: #777777;
			left: 28px;
			margin: 0;
			bottom: -30px;
		}

		@keyframes blink {
			0% {
				opacity: 0.1;
			}
			50% {
				opacity: 0.7;
			}
			100% {
				opacity: 0.1;
			}
		}

		.blink-bus {
			animation-name: blink;
			animation-duration: 3s;
			animation-timing-function: ease-in-out;
			animation-iteration-count: infinite;
			z-index: 100;
			width: 30px;
			position: absolute;
			left: 15px;
			top: -3px;
		}

		.bus-line-footer {
			width: 100%;
			height: 15vw;
			background: #FFFFFF;
		}
		.bus-line-area button {
			position: absolute;
			right: 3vw;
			bottom: 3vw;
		}
		.affix .bus-line-area button {
			display: none;
		}
		
		.btn.btn-xs.board-service-button {
			width: 20vw;
		}
		
		
		/* Bootstrap modal align vertical middle*/
		.modal {
			text-align: center;
			padding: 0 !important;
		}

		.modal:before {
			content: '';
			display: inline-block;
			height: 100%;
			vertical-align: middle;
			margin-right: -4px;
		}

		.modal-dialog {
			display: inline-block;
			text-align: left;
			vertical-align: middle;
		}
		.modal-header {
			/* 		background: #ffeccd; */
			font-size: 1.2em;
			font-weight: bold;
		}
		.modal-body {
			text-align: center;
			max-height: 100vw;
			overflow-y: auto;
		}
		.modal-content {
			border: none;
			border-radius: 0;
		}
		.modal-lg {
			width: 90%;
		}
		
		.stdu-item {
			text-align: left;
			padding: 2vw 0;
			border-bottom: 1px solid 1px solid #dadada;
		}
		.stdu-item:nth-last-child(1){
			border-bottom: none
		}
		
		.stdu-img {
			width: 14vw;
			height: 14vw;
			display: inline-block;
			float: left
		}
		.stdu-img img{
			width: 100%;
			height: 100%;
			padding: 1px;
			border: 1px solid #f3f3f3;
		}
		.stdu-wrap{
			height: 14vw;
			display: inline-block;
			margin-left: 3vw;
		}
		.stdu-name {
			font-size: 5vw;
			line-height: 8vw;
		}
		.stdu-class{
			font-size: 4vw;
			line-height: 6vw;
		}
		.toggle{
			float: right;
			width: 21vw;
			height: 10vw;
			margin: 2vw;
		}
		.toggle-group label{
			font-size: 4vw;
		}
	</style>
	<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
</head>
<body>
<div id="content_wrap">
	<section class="mContents" layout:fragment="content">
		<div class="bus-line-container">
			<!-- The time line -->
			<ul class="timeline">
				<!-- timeline time label -->
				<li class="time-label">
					<div class="bus-line-header">
						<div class="box box-widget widget-user-2">
							<!-- Add the bg color to the header using any of the bg-* classes -->
							<div class="widget-user-header">
								<div class="bus-icon">
									<img class="bus-image" src="/images/common/bus-icon-5.png" />
									<span class="bus-num"></span>
								</div>
								<div class="widget-user-image">
									<img class="img-circle teacher-image" src="" alt="User Avatar" />
									<span class="teacher-name"></span>
								</div>
								<!-- /.widget-user-image -->
								<div class="bus-line-area">
									<span class="bus-line-name"></span>
									<button class="btn bg-green btn-xs board-service-button" th:if="${loginUser.userType.code == 'TCH'}">출발</button>
								</div>
							</div>
						</div>
					</div>
				</li>
				<!-- /.timeline-label -->
			</ul>
		</div>

		<div class="modal" id="myModal" tabindex="-1" role="dialog"
			 aria-labelledby="myModalLabel">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						<h4 class="modal-title" id="myModalLabel">학생 탑승</h4>
					</div>
					<div class="modal-body">
						<ul class="stdu-list">
						</ul>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
						<button type="button" class="btn btn-warning board-process">탑승 처리</button>
					</div>
				</div>
			</div>
		</div>
	</section>
</div>
<script th:inline="javascript" layout:fragment="script">
	/*<![CDATA[*/

	/*[+
	 var lineId = [[${lineId}]];
	 var loginUserType = [[${loginUser.userType.code}]];
	 +]*/

	console.log(lineId);
	console.log(loginUserType);

	var curDate = new Date();
	var curYear = curDate.getFullYear();
	var curMonth = curDate.getMonth() + 1;
	var curDay = curDate.getDate();

	curMonth = curMonth < 10 ? "0" + curMonth : curMonth;
	curDay = curDay < 10 ? "0" + curDay : curDay;

	var histDate =  curYear + "" + curMonth + "" + curDay;
	var lineType;
	
	var boardServiceStarted = false;
	
	var stationList = {};
	$(document).ready(function(){
		$(".bus-line-header").affix({
			offset : {
				top : 30
			}
		});

		if (lineId == null) {
			alert("현재 학생이 승차한 노선이 없습니다.");
			history.back();
			return false;
		}

		initHeaderInfo();
		getBoardService();
	});

	function initHeaderInfo() {
		$.get("/rest/board/lineinfo/" + lineId, function(data, status) {
			lineType = data.lineType;

			console.log(lineType);
			$(".bus-line-name").text(data.lineNm);
			$(".teacher-name").text(data.userNm + " 선생님");
			$(".widget-user-image img").attr("src", "/file/data" + data.imgSrc);
			$(".bus-num").text(data.busNum);

			refresh();
		});
	}

	function refresh() {
		$("ul.timeline li.bus-line-item").remove();

		$.get("/rest/board/list/" + lineId + "/" + histDate, function(data, status) {
			var curFlg = false;
			for (var i = 0; i < data.length; i++) {
				stationList[data[i].lineDtlId] = data[i];
				
				if (curFlg == false && data[i].boardComplete == false) {
					addList(data[i], true);
					curFlg = true;
				} else {
					addList(data[i], false);
				}
			}

			addLast();
		});

	}

	function addLast() {
		if (loginUserType == 'TCH') {
			var busLineLastItemHtml = '<li class="bus-line-item"><div class="bus-line-footer">'+ 
				'<button class="btn bg-red btn-xs board-service-button" onclick="deleteBoardService()">기록삭제</button>' +
				'<button class="btn bg-red btn-xs board-service-button" onclick="endBoardService()">종료</button>' +
				'</div></li>';
		} else {
			var busLineLastItemHtml = '<li class="bus-line-item"><div class="bus-line-footer">'+ 
			'</div></li>';
		}
		
		$("ul.timeline").append(busLineLastItemHtml);
	}

	function addList(lineDtlData, curFlg) {
		var liId = "lineDtl_" + lineDtlData.lineDtlId;
		var readyText = (loginUserType == "TCH") ? ((lineType == "ATT") ? "탑승": "하차") : "대기";
		var completeText = (lineType == "ATT") ? "탑승완료": "하차완료";

		var buttonReadyHtml = '<span class="btn bg-green btn-xs board-ready">' + readyText + '</span>';
		var buttonCompleteHtml = '<span class="btn bg-green btn-xs board-complete">' + completeText + '</span>';
		var blinkBusHtml = '<img class="blink-bus" src="/images/common/school-bus-icon.png" />';

		var busLineItemHtml =
			'<li id="{liId}" class="bus-line-item"><img class="fa fa-envelope img-rounded" /><div class="timeline-item">'
			+ '<h3 class="timeline-header no-border no-current"><span class="time">{boardTime}</span>'
			+ '<div class="button-area"></div>'
			+ '<div class="address"><span class="address">{boardAddress}</span></div></h3></div></li>'
		;
		
		var insertHtml = busLineItemHtml;

		insertHtml = insertHtml.replace("{liId}", liId);
		insertHtml = insertHtml.replace("{imgSrc}", "/file/data" + lineDtlData.imgSrc);
		insertHtml = insertHtml.replace("{studentName}", lineDtlData.userNm);
		insertHtml = insertHtml.replace("{className}", lineDtlData.clsNm + "반");
		insertHtml = insertHtml.replace("{boardTime}", lineDtlData.boardTm.substring(0, 2) + ":" + lineDtlData.boardTm.substring(2, 4));
		insertHtml = insertHtml.replace("{boardAddress}", lineDtlData.boardLoc);

		$("ul.timeline").append(insertHtml);

		// 탑승,하차 완료 처리에 따른 운행 노선 레이아웃 변경 및 버튼 처리
		if (lineDtlData.boardComplete) {
			// 탑승 완료일 경우 버튼 css 처리 
			$("#" + liId + " img.fa").addClass('board');
			$("#" + liId + " .timeline-item").addClass('board');
			$("#" + liId + " .button-area").append(buttonCompleteHtml);
		} else {
			$("#" + liId + " .button-area").append(buttonReadyHtml);
		}

		// 버튼 이벤트 등록 
		$("#" + liId + " .button-area .btn").each(function(){
			$(this).on("click", function(){
				openModal(lineDtlData.lineDtlId, lineType);
			})
		});
		
		// 현재 이동중인 정차역일 경우 버스 표시
		if (curFlg) {
			$("#" + liId).append(blinkBusHtml);
		}

	}

	// 탑승,하차 modal 창 open
	function openModal(liId, lineType) {
		
		$("ul.stdu-list").empty();
		
		// 학생 리스트 데이터 구성
		var studentList = stationList[liId].studentList;
		
		for (var i = 0; i < studentList.length; i++) {
			var studentItem = studentList[i];

			var stduHtml = '<li class="stdu-item" id="{stduId}">'
				+ '<div class="stdu-img"><img src="{imgSrc}" class="img-circle" /></div>' 
				+ '<div class="stdu-wrap"><span class="stdu-name">{name}</span><br/><span class="stdu-class">{clsNm}</span></div>' 
				+ '<input type="checkbox" class="stdu_toogle" data-toggle="toggle" data-onstyle="success" data-on="탑승" data-off="미탑승" data-size="small" checked>'
				+ '</li>'
				;
				
			stduHtml = stduHtml.replace("{stduId}", studentItem.userId);
			stduHtml = stduHtml.replace("{name}", studentItem.userNm);
			stduHtml = stduHtml.replace("{clsNm}", studentItem.clsNm);
			stduHtml = stduHtml.replace("{imgSrc}", studentItem.profileImageUri);
			
			$("ul.stdu-list").append(stduHtml);
		}
		
		// 토글 버튼 적용 
		$('.stdu_toogle').each(function(){
			$(this).bootstrapToggle();
		});
		
		// toggle 버튼 스타일 제거
		$('.toggle').each(function(){
			$(this).removeAttr('style')
		})
		
		// modal 타이틀 역 이름으로 변경 
		$(".modal-title").text(stationList[liId].boardLoc);
		
		// 탑승처리 이벤트 등록 
		$(".board-process").unbind('click');
		$(".board-process").click(function(){
			boardProcess(liId)
		});
		// modal open
		$('#myModal').modal('show');
	}
	
	function boardProcess(liId) {
		// 운행 시작 되었는지 체크 처리
		if (!boardServiceStarted) {
			alert("아직 노선 운행을 시작하지 않았습니다\n운행 출발 버튼을 눌러주세요");
			return false;		
		}
		
		var param = {};

		param.lineId = lineId;
		param.lineDetailId = liId;
		param.histDate = histDate;

		stduArray = [];
		
		$("li.stdu-item").each(function(){
			var stduItem = {};
			
			stduItem.userId = $(this).attr("id");
			stduItem.lineDtlId = liId;
			stduItem.histDate = histDate;
			stduItem.boardDiv = $(this).find(".toggle").hasClass("off") ? "N" : "C";
			
			stduArray.push(stduItem);
		});

		param.processList = stduArray;
		
		console.log(param);
		
		$.ajax({
			type : "POST",
			url : "/rest/board/process",
			data : JSON.stringify(param),
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			success : function(){
				$('#myModal').modal('hide');
				refresh();
			},
			dataType : "JSON"
		});
	}

	function startBoardService() {
		$.ajax({
			type : "POST",
			url : "/rest/board/service/" + lineId,
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			success : function(){
				getBoardService();
				console.log("success");
			},
			dataType : "JSON"
		});
	}
	
	function endBoardService() {
		$.ajax({
			type : "PUT",
			url : "/rest/board/service/" + lineId,
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			success : function(){
				alert("운행이 종료되었습니다.");
				console.log("success");
			},
			dataType : "JSON"
		});
	}
	
	function getBoardService() {
		$.get("/rest/board/service/" + lineId, function(result, status) {
			if (result.code == "0") {
				$(".bus-line-area .board-service-button").text("출발완료");
				
				boardServiceStarted = true;
			} else {
				$(".bus-line-area .board-service-button").text("출발");
				$(".bus-line-area .board-service-button").click(startBoardService);
				
				boardServiceStarted = false;
			}
		});
	}
	
	function deleteBoardService() {
		$.ajax({
			type : "DELETE",
			url : "/rest/board/service/" + lineId + "/" + histDate,
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			success : function(){
				getBoardService();
				refresh();
			},
			dataType : "JSON"
		});
	}

	/*]]>*/
</script>
</body>
</html>
